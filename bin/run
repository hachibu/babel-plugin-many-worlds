#!/usr/bin/env node

var _      = require('lodash'),
    babel  = require('@babel/core'),
    plugin = require('../src/plugin'),
    Tree   = require('../src/tree'),
    yargs  = require('yargs');

var argv = yargs
  .usage(
    '$0 <filepath>',
    'Explore the many-worlds interpretation of quantum mechanics and see mistakes you might have made in another universe.',
    (yargs) => yargs.positional('filepath', {
      describe: 'JavaScript filepath.',
      type: 'string',
    })
  )
  .option('depth', {
    alias: 'd',
    default: 0,
    describe: 'Depth of recursion.',
    type: 'number',
  })
  .argv;

function printResult({ code, id }) {
  console.log(`/* ${id} */`);
  console.log(code, "\n");
}

async function main() {
  var options = {
    plugins: [plugin]
  };

  var t = new Tree();

  t.data = {
    id: 'World 0',
    code: babel.transformFileSync(argv.filepath).code
  };

  function branch(node) {
    var a = new Tree();
    var b = new Tree();

    a.data = {
      id: `${node.data.id} => World ${node.depth}₀`,
      code: babel.transformSync(node.data.code, options).code
    };
    b.data = {
      id: `${node.data.id} => World ${node.depth}₁`,
      code: babel.transformSync(node.data.code, options).code
    };

    node.insert(a);
    node.insert(b);
  }

  var depth = -1;

  while (++depth < argv.depth) {
    t.each(node => {
      if (node.depth === depth) {
        branch(node);
      }
    });
  }

  t.print();
}

main();
